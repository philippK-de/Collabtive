var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(d,l,p){if(p.get||p.set)throw new TypeError("ES3 does not support getters and setters.");d!=Array.prototype&&d!=Object.prototype&&(d[l]=p.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(d){return $jscomp.SYMBOL_PREFIX+(d||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var l=0;return $jscomp.iteratorPrototype(function(){return l<d.length?{done:!1,value:d[l++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.makeIterator=function(d){$jscomp.initSymbolIterator();var l=d[Symbol.iterator];return l?l.call(d):$jscomp.arrayIterator(d)};
$jscomp.polyfill=function(d,l,p,g){if(l){p=$jscomp.global;d=d.split(".");for(g=0;g<d.length-1;g++){var n=d[g];n in p||(p[n]={});p=p[n]}d=d[d.length-1];g=p[d];l=l(g);l!=g&&null!=l&&$jscomp.defineProperty(p,d,{configurable:!0,writable:!0,value:l})}};$jscomp.EXPOSE_ASYNC_EXECUTOR=!0;$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(d){function l(){this.batch_=null}if(d&&!$jscomp.FORCE_POLYFILL_PROMISE)return d;l.prototype.asyncExecute=function(f){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(f);return this};l.prototype.asyncExecuteBatch_=function(){var f=this;this.asyncExecuteFunction(function(){f.executeBatch_()})};var p=$jscomp.global.setTimeout;l.prototype.asyncExecuteFunction=function(f){p(f,0)};l.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var f=
this.batch_;this.batch_=[];for(var d=0;d<f.length;++d){var g=f[d];delete f[d];try{g()}catch(S){this.asyncThrow_(S)}}}this.batch_=null};l.prototype.asyncThrow_=function(f){this.asyncExecuteFunction(function(){throw f;})};var g=function(f){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var d=this.createResolveAndReject_();try{f(d.resolve,d.reject)}catch(P){d.reject(P)}};g.prototype.createResolveAndReject_=function(){function f(f){return function(R){g||(g=!0,f.call(d,R))}}var d=this,g=
!1;return{resolve:f(this.resolveTo_),reject:f(this.reject_)}};g.prototype.resolveTo_=function(f){if(f===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(f instanceof g)this.settleSameAsPromise_(f);else{var d;a:switch(typeof f){case "object":d=null!=f;break a;case "function":d=!0;break a;default:d=!1}d?this.resolveToNonPromiseObj_(f):this.fulfill_(f)}};g.prototype.resolveToNonPromiseObj_=function(d){var f=void 0;try{f=d.then}catch(P){this.reject_(P);return}"function"==
typeof f?this.settleSameAsThenable_(f,d):this.fulfill_(d)};g.prototype.reject_=function(d){this.settle_(2,d)};g.prototype.fulfill_=function(d){this.settle_(1,d)};g.prototype.settle_=function(d,g){if(0!=this.state_)throw Error("Cannot settle("+d+", "+g|"): Promise already settled in state"+this.state_);this.state_=d;this.result_=g;this.executeOnSettledCallbacks_()};g.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var d=this.onSettledCallbacks_,g=0;g<d.length;++g)d[g].call(),
d[g]=null;this.onSettledCallbacks_=null}};var n=new l;g.prototype.settleSameAsPromise_=function(d){var f=this.createResolveAndReject_();d.callWhenSettled_(f.resolve,f.reject)};g.prototype.settleSameAsThenable_=function(d,g){var f=this.createResolveAndReject_();try{d.call(g,f.resolve,f.reject)}catch(S){f.reject(S)}};g.prototype.then=function(d,l){function f(d,f){return"function"==typeof d?function(f){try{p(d(f))}catch(T){n(T)}}:f}var p,n,R=new g(function(d,f){p=d;n=f});this.callWhenSettled_(f(d,p),
f(l,n));return R};g.prototype.catch=function(d){return this.then(void 0,d)};g.prototype.callWhenSettled_=function(d,g){function f(){switch(l.state_){case 1:d(l.result_);break;case 2:g(l.result_);break;default:throw Error("Unexpected state: "+l.state_);}}var l=this;null==this.onSettledCallbacks_?n.asyncExecute(f):this.onSettledCallbacks_.push(function(){n.asyncExecute(f)})};g.resolve=function(d){return d instanceof g?d:new g(function(f,g){f(d)})};g.reject=function(d){return new g(function(f,g){g(d)})};
g.race=function(d){return new g(function(f,l){for(var p=$jscomp.makeIterator(d),n=p.next();!n.done;n=p.next())g.resolve(n.value).callWhenSettled_(f,l)})};g.all=function(d){var f=$jscomp.makeIterator(d),l=f.next();return l.done?g.resolve([]):new g(function(d,p){function n(f){return function(g){u[f]=g;v--;0==v&&d(u)}}var u=[],v=0;do u.push(void 0),v++,g.resolve(l.value).callWhenSettled_(n(u.length-1),p),l=f.next();while(!l.done)})};$jscomp.EXPOSE_ASYNC_EXECUTOR&&(g.$jscomp$new$AsyncExecutor=function(){return new l});
return g},"es6-impl","es3");$jscomp.findInternal=function(d,l,p){d instanceof String&&(d=String(d));for(var g=d.length,n=0;n<g;n++){var f=d[n];if(l.call(p,f,n,d))return{i:n,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(d,p){return $jscomp.findInternal(this,d,p).v}},"es6-impl","es3");
!function(){function d(e,a){return p(document.createElement("canvas"),e,a)}function l(e){return e.getContext("2d")}function p(e,a,b){return e.width=a,e.height=b,e}function g(){return new (M.getOrDie("FileReader"))}function n(e){return new I(function(a,b){function c(){d();a(k)}function m(){d();b("Unable to load data of type "+e.type+": "+h)}var h=URL.createObjectURL(e),k=new Image,d=function(){k.removeEventListener("load",c);k.removeEventListener("error",m)};k.addEventListener("load",c);k.addEventListener("error",
m);k.src=h;k.complete&&c()})}function f(e){return new I(function(a,b){var c=new XMLHttpRequest;c.open("GET",e,!0);c.responseType="blob";c.onload=function(){200==this.status&&a(this.response)};c.onerror=function(){var a;b(0===this.status?((a=Error("No access to download image")).code=18,a.name="SecurityError",a):Error("Error "+this.status+" downloading image"))};c.send()})}function R(e){var a=e.split(",");e=/data:([^;]+)/.exec(a[0]);if(!e)return oa.none();var b,c;e=e[1];for(var a=Xa.atob(a[1]),m=a.length,
h=Math.ceil(m/1024),k=Array(h),d=0;d<h;++d){for(var q=1024*d,r=Math.min(q+1024,m),f=Array(r-q),g=0;q<r;++g,++q)f[g]=a[q].charCodeAt(0);k[d]=(b=f,new (M.getOrDie("Uint8Array"))(b))}return oa.some((c={type:e},new (M.getOrDie("Blob"))(k,c)))}function P(e){return new I(function(a,b){R(e).fold(function(){b("uri is not base64: "+e)},a)})}function S(e){return new I(function(a){var b=new g;b.onloadend=function(){a(b.result)};b.readAsDataURL(e)})}function ra(e,a,b){function c(a,b){return e.then(function(c){return N.canvasToDataURL(c,
a,b)})}return{getType:J.constant(a.type),toBlob:function(){return I.resolve(a)},toDataURL:function(){return b},toBase64:function(){return b.split(",")[1]},toAdjustedBlob:function(a,b){return e.then(function(c){return N.canvasToBlob(c,a,b)})},toAdjustedDataURL:c,toAdjustedBase64:function(a,b){return c(a,b).then(function(a){return a.split(",")[1]})},toCanvas:function(){return e.then(A.clone)}}}function Ba(e){return N.blobToDataUri(e).then(function(a){return ra(N.blobToCanvas(e),e,a)})}function u(e,
a,b){return(e=parseFloat(e))>b?e=b:e<a&&(e=a),e}function v(e,a){var b,c,m,h,k=[],d=Array(10);for(b=0;5>b;b++){for(c=0;5>c;c++)k[c]=a[c+5*b];for(c=0;5>c;c++){for(m=h=0;5>m;m++)h+=e[c+5*m]*k[m];d[c+5*b]=h}}return d}function sa(e,a){return a=u(a,0,1),e.map(function(b,c){return 0==c%6?b=1-(1-b)*a:b*=a,u(b,0,1)})}function T(e,a){return e.toCanvas().then(function(b){v=b;z=e.getType();t=a;C=A.get2dContext(v);b=C.getImageData(0,0,v.width,v.height);var c,m,h,k,d=b.data,q=t[0],r=t[1],f=t[2],g=t[3],l=t[4],y=
t[5],p=t[6],U=t[7],n=t[8],V=t[9],w=t[10],G=t[11],Y=t[12],E=t[13],ja=t[14],x=t[15],Za=t[16],F=t[17],B=t[18],u=t[19];for(k=0;k<d.length;k+=4)t=d[k],c=d[k+1],m=d[k+2],h=d[k+3],d[k]=t*q+c*r+m*f+h*g+l,d[k+1]=t*y+c*p+m*U+h*n+V,d[k+2]=t*w+c*G+m*Y+h*E+ja,d[k+3]=t*x+c*Za+m*F+h*B+u;return D=b,C.putImageData(D,0,0),H.fromCanvas(v,z);var v,z,t,D,C})}function Ca(e,a){return e.toCanvas().then(function(b){return c=b,m=e.getType(),h=a,q=A.get2dContext(c),d=q.getImageData(0,0,c.width,c.height),f=q.getImageData(0,
0,c.width,c.height),f=function(a,b,c){function e(a,b,c){return a>c?a=c:a<b&&(a=b),a}var h,m,d,k,r,f,G,q,g,ia,X,l,da,p;d=Math.round(Math.sqrt(c.length));k=Math.floor(d/2);h=a.data;m=b.data;da=a.width;p=a.height;for(r=0;r<p;r++)for(a=0;a<da;a++){for(ia=f=G=q=0;ia<d;ia++)for(g=0;g<d;g++)X=e(a+g-k,0,da-1),l=e(r+ia-k,0,p-1),X=4*(l*da+X),l=c[ia*d+g],f+=h[X]*l,G+=h[X+1]*l,q+=h[X+2]*l;m[X=4*(r*da+a)]=e(f,0,255);m[X+1]=e(G,0,255);m[X+2]=e(q,0,255)}return b}(d,f,h),q.putImageData(f,0,0),H.fromCanvas(c,m);var c,
m,h,d,f,q})}function Da(e){return function(a,b){return a.toCanvas().then(function(c){var m=a.getType(),h,d=A.get2dContext(c),f=Array(256);for(h=0;h<f.length;h++)f[h]=e(h,b);h=d.getImageData(0,0,c.width,c.height);var q,r=h.data;for(q=0;q<r.length;q+=4)r[q]=f[r[q]],r[q+1]=f[r[q+1]],r[q+2]=f[r[q+2]];return d.putImageData(h,0,0),H.fromCanvas(c,m)})}}function K(e){return function(a,b){return T(a,e(L.identity(),b))}}function Ea(e){return function(a){return Ca(a,e)}}function ea(e){return{blob:e,url:ta.createObjectURL(e)}}
function fa(e){e&&ta.revokeObjectURL(e.url)}function $a(e,a,b,c){function m(a){var b,c,e,h;b=w.find("#w")[0];c=w.find("#h")[0];e=parseInt(b.value(),10);h=parseInt(c.value(),10);w.find("#constrain")[0].checked()&&ba&&ca&&e&&h&&("w"===a.control.settings.name?(h=Math.round(e*S),c.value(h)):(e=Math.round(h*T),b.value(e)));ba=e;ca=h}function h(a){return Math.round(100*a)+"%"}function d(){w.find("#undo").disabled(!Z.canUndo());w.find("#redo").disabled(!Z.canRedo());w.statusbar.find("#save").disabled(!Z.canUndo())}
function f(){w.find("#undo").disabled(!0);w.find("#redo").disabled(!0)}function q(a){a&&F.imageSrc(a.url)}function r(a){return function(){var b=B.grep(R,function(b){return b.settings.name!==a});B.each(b,function(a){a.hide()});a.show();a.focus()}}function g(a){q(E=ea(a))}function l(b){q(a=ea(b));B.each(Z.add(a).removed,fa);d()}function p(){var b=F.selection();aa.blobToImageResult(a.blob).then(function(a){x.crop(a,b.x,b.y,b.w,b.h).then(K).then(function(a){l(a);y()})})}function y(){q(a);fa(E);r(G)();
d()}function n(){E?(l(E.blob),y()):function ab(a,b){E?b():setTimeout(function(){0<a--?ab(a,b):e.windowManager.alert("Error: failed to apply image operation.")},10)}(100,n)}function U(a){return ka.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:a})}function u(b,c){return U(W([{text:"Back",onclick:y},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",
onclick:n}])).hide().on("show",function(){f();aa.blobToImageResult(a.blob).then(function(a){return c(a)}).then(K).then(function(a){a=ea(a);q(a);fa(E);E=a})})}function V(b,c,d,m,k){return U(W([{text:"Back",onclick:y},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(b){var e;e=b.value;aa.blobToImageResult(a.blob).then(function(a){return c(a,e)}).then(K).then(function(a){a=ea(a);q(a);fa(E);E=a})},minValue:e.rtl?k:m,maxValue:e.rtl?m:k,value:d,previewFilter:h},{type:"spacer",flex:1},{text:"Apply",
subtype:"primary",onclick:n}])).hide().on("show",function(){this.find("slider").value(d);f()})}var w,G,Y,E,ja,v,A,F,z,C,D,H,t,I,N,J,L,M,O,P,Q,R,ba,ca,S,T,Z=function(){function a(){return-1!==c&&c<b.length-1}var b=[],c=-1;return{data:b,add:function(a){var e;return e=b.splice(++c),b.push(a),{state:a,removed:e}},undo:function(){if(0<c)return b[--c]},redo:function(){if(a())return b[++c]},canUndo:function(){return 0<c},canRedo:a}}(),W=function(a){return e.rtl?a.reverse():a};Y=function(b){var c=[].slice.call(arguments,
1);return function(){aa.blobToImageResult((E||a).blob).then(function(a){b.apply(this,[a].concat(c)).then(K).then(g)})}};var K=function(a){return a.toBlob()};ja=U(W([{text:"Back",onclick:y},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:p}])).hide().on("show hide",function(a){F.toggleCropRect("show"===a.type)}).on("show",f);v=U(W([{text:"Back",onclick:y},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:m},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:m},
{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(a){!0===a.control.value()&&(S=ca/ba,T=ba/ca)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",function(b){var c=parseInt(w.find("#w").value(),10),e=parseInt(w.find("#h").value(),10);b.preventDefault();(function(b){for(var c=1;c<arguments.length;c++);var e=[].slice.call(arguments,1);return function(){aa.blobToImageResult(a.blob).then(function(a){b.apply(this,[a].concat(e)).then(K).then(l)})}})(x.resize,
c,e)();y()}).on("show",f);A=U(W([{text:"Back",onclick:y},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:Y(x.flip,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:Y(x.flip,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:Y(x.rotate,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:Y(x.rotate,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:n}])).hide().on("show",f);C=u(0,x.invert);M=u(0,x.sharpen);O=u(0,x.emboss);D=V(0,
x.brightness,0,-1,1);H=V(0,x.hue,180,0,360);t=V(0,x.saturate,0,-1,1);I=V(0,x.contrast,0,-1,1);N=V(0,x.grayscale,0,0,1);J=V(0,x.sepia,0,0,1);L=function(b,c){function d(){var b,e,h;b=w.find("#r")[0].value();e=w.find("#g")[0].value();h=w.find("#b")[0].value();aa.blobToImageResult(a.blob).then(function(a){return c(a,b,e,h)}).then(K).then(function(a){a=ea(a);q(a);fa(E);E=a})}b=e.rtl?2:0;var m=e.rtl?0:2;return U(W([{text:"Back",onclick:y},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:b,
value:1,maxValue:m,ondragend:d,previewFilter:h},{type:"slider",label:"G",name:"g",minValue:b,value:1,maxValue:m,ondragend:d,previewFilter:h},{type:"slider",label:"B",name:"b",minValue:b,value:1,maxValue:m,ondragend:d,previewFilter:h},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:n}])).hide().on("show",function(){w.find("#r,#g,#b").value(1);f()})}(0,x.colorize);P=V(0,x.gamma,0,-1,1);Q=V(0,x.exposure,1,0,2);Y=U(W([{text:"Back",onclick:y},{type:"spacer",flex:1},{text:"hue",icon:"hue",
onclick:r(H)},{text:"saturate",icon:"saturate",onclick:r(t)},{text:"sepia",icon:"sepia",onclick:r(J)},{text:"emboss",icon:"emboss",onclick:r(O)},{text:"exposure",icon:"exposure",onclick:r(Q)},{type:"spacer",flex:1}])).hide();G=U(W([{tooltip:"Crop",icon:"crop",onclick:r(ja)},{tooltip:"Resize",icon:"resize2",onclick:r(v)},{tooltip:"Orientation",icon:"orientation",onclick:r(A)},{tooltip:"Brightness",icon:"sun",onclick:r(D)},{tooltip:"Sharpen",icon:"sharpen",onclick:r(M)},{tooltip:"Contrast",icon:"contrast",
onclick:r(I)},{tooltip:"Color levels",icon:"drop",onclick:r(L)},{tooltip:"Gamma",icon:"gamma",onclick:r(P)},{tooltip:"Invert",icon:"invert",onclick:r(C)}]));F=bb.create({flex:1,imageSrc:a.url});z=ka.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){q(a=Z.undo());d()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){q(a=Z.redo());d()}},{type:"button",
icon:"zoomin",tooltip:"Zoom in",onclick:function(){var a=F.zoom();2>a&&(a+=.1);F.zoom(a)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var a=F.zoom();.1<a&&(a-=.1);F.zoom(a)}}]});z=ka.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:W([z,F])});R=[G,ja,v,A,Y,C,D,H,t,I,N,J,L,M,O,P,Q];(w=e.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(Fa.DOM.getViewPort().w,800),minHeight:Math.min(Fa.DOM.getViewPort().h,
650),title:"Edit image",items:R.concat([z]),buttons:W([{text:"Save",name:"save",subtype:"primary",onclick:function(){b(a.blob);w.close()}},{text:"Cancel",onclick:"close"}])})).on("close",function(){c();B.each(Z.data,fa);E=Z=null});Z.add(a);d();F.on("load",function(){ba=F.imageSize().w;ca=F.imageSize().h;S=ca/ba;T=ba/ca;w.find("#w").value(ba);w.find("#h").value(ca)});F.on("crop",p)}var ua=function(e){var a=e;return{get:function(){return a},set:function(b){a=b},clone:function(){return ua(a)}}},cb=tinymce.util.Tools.resolve("tinymce.PluginManager"),
B=tinymce.util.Tools.resolve("tinymce.util.Tools"),Ga,Ha,Ia,va,A={create:d,clone:function(e){var a;return l(a=d(e.width,e.height)).drawImage(e,0,0),a},resize:p,get2dContext:l,get3dContext:function(e){var a=null;try{a=e.getContext("webgl")||e.getContext("experimental-webgl")}catch(b){}return a||(a=null),a}},ga={getWidth:function(e){return e.naturalWidth||e.width},getHeight:function(e){return e.naturalHeight||e.height}},I=window.Promise?window.Promise:function(){function e(a,b){return function(){a.apply(b,
arguments)}}function a(a){var b=this;null!==this._state?f(function(){var c=b._state?a.onFulfilled:a.onRejected;if(null!==c){var e;try{e=c(b._value)}catch(y){return void a.reject(y)}a.resolve(e)}else(b._state?a.resolve:a.reject)(b._value)}):this._deferreds.push(a)}function b(a){try{if(a===this)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var m=a.then;if("function"==typeof m)return void h(e(m,a),e(b,this),e(c,this))}this._state=!0;
this._value=a;d.call(this)}catch(da){c.call(this,da)}}function c(a){this._state=!1;this._value=a;d.call(this)}function d(){for(var b=0,c=this._deferreds.length;b<c;b++)a.call(this,this._deferreds[b]);this._deferreds=null}function h(a,b,c){var e=!1;try{a(function(a){e||(e=!0,b(a))},function(a){e||(e=!0,c(a))})}catch(y){e||(e=!0,c(y))}}var k=function(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");
this._value=this._state=null;this._deferreds=[];h(a,e(b,this),e(c,this))},f=k.immediateFn||"function"==typeof setImmediate&&setImmediate||function(a){setTimeout(a,1)},q=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};return k.prototype["catch"]=function(a){return this.then(null,a)},k.prototype.then=function(b,c){var e=this;return new k(function(h,d){a.call(e,new function(a,b,c,e){this.onFulfilled="function"==typeof a?a:null;this.onRejected="function"==typeof b?
b:null;this.resolve=c;this.reject=e}(b,c,h,d))})},k.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&q(arguments[0])?arguments[0]:arguments);return new k(function(b,c){function e(d,m){try{if(m&&("object"==typeof m||"function"==typeof m)){var k=m.then;if("function"==typeof k)return void k.call(m,function(a){e(d,a)},c)}a[d]=m;0==--h&&b(a)}catch(w){c(w)}}if(0===a.length)return b([]);for(var h=a.length,d=0;d<a.length;d++)e(d,a[d])})},k.resolve=function(a){return a&&"object"==typeof a&&
a.constructor===k?a:new k(function(b){b(a)})},k.reject=function(a){return new k(function(b,c){c(a)})},k.race=function(a){return new k(function(b,c){for(var e=0,d=a.length;e<d;e++)a[e].then(b,c)})},k}(),wa=function(e){return function(){return e}},J={noop:function(){},noarg:function(e){return function(){return e()}},compose:function(e,a){return function(){return e(a.apply(null,arguments))}},constant:wa,identity:function(e){return e},tripleEquals:function(e,a){return e===a},curry:function(e){for(var a=
Array(arguments.length-1),b=1;b<arguments.length;b++)a[b-1]=arguments[b];return function(){for(var b=Array(arguments.length),d=0;d<b.length;d++)b[d]=arguments[d];b=a.concat(b);return e.apply(null,b)}},not:function(e){return function(){return!e.apply(null,arguments)}},die:function(e){return function(){throw Error(e);}},apply:function(e){return e()},call:function(e){e()},never:wa(!1),always:wa(!0)},la=J.never,xa=J.always,Q=function(){return ya},ya=(va={fold:function(e,a){return e()},is:la,isSome:la,
isNone:xa,getOr:Ia=function(e){return e},getOrThunk:Ha=function(e){return e()},getOrDie:function(e){throw Error(e||"error: getOrDie called on none.");},or:Ia,orThunk:Ha,map:Q,ap:Q,each:function(){},bind:Q,flatten:Q,exists:la,forall:xa,filter:Q,equals:Ga=function(e){return e.isNone()},equals_:Ga,toArray:function(){return[]},toString:J.constant("none()")},Object.freeze&&Object.freeze(va),va),pa=function(e){var a=function(){return e},b=function(){return d},c=function(a){return a(e)},d={fold:function(a,
b){return b(e)},is:function(a){return e===a},isSome:xa,isNone:la,getOr:a,getOrThunk:a,getOrDie:a,or:b,orThunk:b,map:function(a){return pa(a(e))},ap:function(a){return a.fold(Q,function(a){return pa(a(e))})},each:function(a){a(e)},bind:c,flatten:a,exists:c,forall:c,filter:function(a){return a(e)?d:ya},equals:function(a){return a.is(e)},equals_:function(a,b){return a.fold(la,function(a){return b(e,a)})},toArray:function(){return[e]},toString:function(){return"some("+e+")"}};return d},oa={some:pa,none:Q,
from:function(e){return null===e||void 0===e?ya:pa(e)}},db="undefined"!=typeof window?window:Function("return this;")(),M={getOrDie:function(e,a){var b;b=e.split(".");a=void 0!==a&&null!==a?a:db;for(var c=0;c<b.length&&void 0!==a&&null!==a;++c)a=a[b[c]];b=a;if(void 0===b||null===b)throw e+" not available on this browser";return b}},Xa={atob:function(e){return M.getOrDie("atob")(e)},requestAnimationFrame:function(e){M.getOrDie("requestAnimationFrame")(e)}},N={blobToImage:n,imageToBlob:function(e){return(a=
e,new I(function(b){a.complete?b(a):a.addEventListener("load",function m(){a.removeEventListener("load",m);b(a)})})).then(function(a){a=a.src;return 0===a.indexOf("blob:")?f(a):0===a.indexOf("data:")?P(a):f(a)});var a},blobToDataUri:S,blobToBase64:function(e){return S(e).then(function(a){return a.split(",")[1]})},dataUriToBlobSync:R,canvasToBlob:function(e,a,b){return a=a||"image/png",HTMLCanvasElement.prototype.toBlob?new I(function(c){e.toBlob(function(a){c(a)},a,b)}):P(e.toDataURL(a,b))},canvasToDataURL:function(e,
a,b){return a=a||"image/png",e.then(function(c){return c.toDataURL(a,b)})},blobToCanvas:function(e){return n(e).then(function(a){var b;return URL.revokeObjectURL(a.src),b=A.create(ga.getWidth(a),ga.getHeight(a)),A.get2dContext(b).drawImage(a,0,0),b})},uriToBlob:function(e){return 0===e.indexOf("blob:")?f(e):0===e.indexOf("data:")?P(e):null}},H={fromBlob:Ba,fromCanvas:function(e,a){return N.canvasToBlob(e,a).then(function(a){return ra(I.resolve(e),a,e.toDataURL())})},fromImage:function(e){return N.imageToBlob(e).then(function(a){return Ba(a)})},
fromBlobAndUrlSync:function(e,a){return ra(N.blobToCanvas(e),e,a)}},za=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],L={identity:function(){return[1,
0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]},adjust:sa,multiply:v,adjustContrast:function(e,a){var b;return a=u(a,-1,1),v(e,[(b=0>(a*=100)?127+a/100*127:127*(b=0==(b=a%1)?za[a]:za[Math.floor(a)]*(1-b)+za[Math.floor(a)+1]*b)+127)/127,0,0,0,.5*(127-b),0,b/127,0,0,.5*(127-b),0,0,b/127,0,.5*(127-b),0,0,0,1,0,0,0,0,0,1])},adjustBrightness:function(e,a){return v(e,[1,0,0,0,a=u(255*a,-255,255),0,1,0,0,a,0,0,1,0,a,0,0,0,1,0,0,0,0,0,1])},adjustSaturation:function(e,a){var b;return v(e,[.3086*(1-(b=1+
(0<(a=u(a,-1,1))?3*a:a)))+b,.6094*(1-b),.082*(1-b),0,0,.3086*(1-b),.6094*(1-b)+b,.082*(1-b),0,0,.3086*(1-b),.6094*(1-b),.082*(1-b)+b,0,0,0,0,0,1,0,0,0,0,0,1])},adjustHue:function(e,a){var b,c;return a=u(a,-180,180)/180*Math.PI,v(e,[.213+.787*(b=Math.cos(a))+-.213*(c=Math.sin(a)),.715+-.715*b+-.715*c,.072+-.072*b+.928*c,0,0,.213+-.213*b+.143*c,.715+b*(1-.715)+.14*c,.072+-.072*b+-.283*c,0,0,.213+-.213*b+-.787*c,.715+-.715*b+.715*c,.072+.928*b+.072*c,0,0,0,0,0,1,0,0,0,0,0,1])},adjustColors:function(e,
a,b,c){return v(e,[u(a,0,2),0,0,0,0,0,u(b,0,2),0,0,0,0,0,u(c,0,2),0,0,0,0,0,1,0,0,0,0,0,1])},adjustSepia:function(e,a){return v(e,sa([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],u(a,0,1)))},adjustGrayscale:function(e,a){return v(e,sa([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],u(a,0,1)))}},Ja,z={invert:(Ja=[-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0],function(e){return T(e,Ja)}),brightness:K(L.adjustBrightness),hue:K(L.adjustHue),saturate:K(L.adjustSaturation),
contrast:K(L.adjustContrast),grayscale:K(L.adjustGrayscale),sepia:K(L.adjustSepia),colorize:function(e,a,b,c){return T(e,L.adjustColors(L.identity(),a,b,c))},sharpen:Ea([0,-1,0,-1,5,-1,0,-1,0]),emboss:Ea([-2,-1,0,-1,1,1,0,1,2]),gamma:Da(function(e,a){return 255*Math.pow(e/255,1-a)}),exposure:Da(function(e,a){return 255*(1-Math.exp(-e/255*a))}),colorFilter:T,convoluteFilter:Ca},eb={scale:function a(b,c,d){var h=ga.getWidth(b),m=ga.getHeight(b),h=c/h,f=d/m,m=!1;(.5>h||2<h)&&(h=.5>h?.5:2,m=!0);(.5>f||
2<f)&&(f=.5>f?.5:2,m=!0);var q,g,h=(q=h,g=f,new I(function(a){var c=ga.getWidth(b),d=ga.getHeight(b),m=Math.floor(c*q),h=Math.floor(d*g),k=A.create(m,h);A.get2dContext(k).drawImage(b,0,0,c,d,0,0,m,h);a(k)}));return m?h.then(function(b){return a(b,c,d)}):h}},qa={rotate:function(a,b){return a.toCanvas().then(function(c){return d=c,h=a.getType(),k=b,f=A.create(d.width,d.height),g=A.get2dContext(f),r=0,l=0,90!=(k=0>k?360+k:k)&&270!=k||A.resize(f,f.height,f.width),90!=k&&180!=k||(r=f.width),270!=k&&180!=
k||(l=f.height),g.translate(r,l),g.rotate(k*Math.PI/180),g.drawImage(d,0,0),H.fromCanvas(f,h);var d,h,k,f,g,r,l})},flip:function(a,b){return a.toCanvas().then(function(c){return d=c,h=a.getType(),k=b,f=A.create(d.width,d.height),g=A.get2dContext(f),"v"==k?(g.scale(1,-1),g.drawImage(d,0,-f.height)):(g.scale(-1,1),g.drawImage(d,-f.width,0)),H.fromCanvas(f,h);var d,h,k,f,g})},crop:function(a,b,c,d,h){return a.toCanvas().then(function(m){return f=m,k=a.getType(),g=b,l=c,p=d,n=h,y=A.create(p,n),A.get2dContext(y).drawImage(f,
-g,-l),H.fromCanvas(y,k);var f,k,g,l,p,n,y})},resize:function(a,b,c){return a.toCanvas().then(function(d){return eb.scale(d,b,c).then(function(b){return H.fromCanvas(b,a.getType())})})}},x={invert:function(a){return z.invert(a)},sharpen:function(a){return z.sharpen(a)},emboss:function(a){return z.emboss(a)},brightness:function(a,b){return z.brightness(a,b)},hue:function(a,b){return z.hue(a,b)},saturate:function(a,b){return z.saturate(a,b)},contrast:function(a,b){return z.contrast(a,b)},grayscale:function(a,
b){return z.grayscale(a,b)},sepia:function(a,b){return z.sepia(a,b)},colorize:function(a,b,c,d){return z.colorize(a,b,c,d)},gamma:function(a,b){return z.gamma(a,b)},exposure:function(a,b){return z.exposure(a,b)},flip:function(a,b){return qa.flip(a,b)},crop:function(a,b,c,d,h){return qa.crop(a,b,c,d,h)},resize:function(a,b,c){return qa.resize(a,b,c)},rotate:function(a,b){return qa.rotate(a,b)}},Ka=function(a){return a.toBlob()},aa={blobToImageResult:function(a){return H.fromBlob(a)},fromBlobAndUrlSync:function(a,
b){return H.fromBlobAndUrlSync(a,b)},imageToImageResult:function(a){return H.fromImage(a)},imageResultToBlob:function(a,b,c){return void 0===b&&void 0===c?Ka(a):a.toAdjustedBlob(b,c)},imageResultToOriginalBlob:Ka,imageResultToDataURL:function(a){return a.toDataURL()}},ta={createObjectURL:function(a){return M.getOrDie("URL").createObjectURL(a)},revokeObjectURL:function(a){M.getOrDie("URL").revokeObjectURL(a)}},fb=tinymce.util.Tools.resolve("tinymce.util.Delay"),D=tinymce.util.Tools.resolve("tinymce.util.Promise"),
Aa=tinymce.util.Tools.resolve("tinymce.util.URI"),Fa=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),ka=tinymce.util.Tools.resolve("tinymce.ui.Factory"),La=tinymce.util.Tools.resolve("tinymce.geom.Rect"),gb=function(a){return new D(function(b){var c=function(){a.removeEventListener("load",c);b(a)};a.complete?b(a):a.addEventListener("load",c)})},C=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),hb=tinymce.util.Tools.resolve("tinymce.util.Observable"),ha=tinymce.util.Tools.resolve("tinymce.util.VK"),
ib=0,bb={create:function(a){return new (ka.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(a){return arguments.length?(this.state.set("rect",a),this):this.state.get("rect")},imageSize:function(){var a=this.state.get("viewRect");return{w:a.w,h:a.h}},toggleCropRect:function(a){this.state.set("cropEnabled",a)},imageSrc:function(a){var b=this,d=new Image;d.src=a;gb(d).then(function(){var a,c=b.state.get("viewRect");(a=b.$el.find("img"))[0]?a.replaceWith(d):(a=document.createElement("div"),
a.className="mce-imagepanel-bg",b.getEl().appendChild(a),b.getEl().appendChild(d));a={x:0,y:0,w:d.naturalWidth,h:d.naturalHeight};b.state.set("viewRect",a);b.state.set("rect",La.inflate(a,-20,-20));c&&c.w===a.w&&c.h===a.h||b.zoomFit();b.repaintImage();b.fire("load")})},zoom:function(a){return arguments.length?(this.state.set("zoom",a),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var a,c,d;a=this.$el.find("img");
c=this.getEl().clientWidth;d=this.getEl().clientHeight;1<=(a=Math.min((c-10)/a[0].naturalWidth,(d-10)/a[0].naturalHeight))&&(a=1);this.zoom(a)},repaintImage:function(){var a,c,d,h,f,g,q,l,p,n;a=this.getEl();p=this.zoom();n=this.state.get("rect");q=this.$el.find("img");l=this.$el.find(".mce-imagepanel-bg");f=a.offsetWidth;g=a.offsetHeight;d=q[0].naturalWidth*p;h=q[0].naturalHeight*p;a=Math.max(0,f/2-d/2);c=Math.max(0,g/2-h/2);q.css({left:a,top:c,width:d,height:h});l.css({left:a,top:c,width:d,height:h});
this.cropRect&&(this.cropRect.setRect({x:n.x*p+a,y:n.y*p+c,w:n.w*p,h:n.h*p}),this.cropRect.setClampRect({x:a,y:c,w:d,h:h}),this.cropRect.setViewPortRect({x:0,y:0,w:f,h:g}))},bindStates:function(){function a(a){c.cropRect=function(a,b,c,d,m){function h(b,d,h,f){var m,g,G;m=d.x;g=d.y;G=d.w;d=d.h;m+=h*b.deltaX;g+=f*b.deltaY;20>(G+=h*b.deltaW)&&(G=20);20>(d+=f*b.deltaH)&&(d=20);b=a=La.clamp({x:m,y:g,w:G,h:d},c,"move"===b.name);b={x:b.x-c.x,y:b.y-c.y,w:b.w,h:b.h};l.fire("updateRect",{rect:b});k(b)}function f(a){function c(a,
b){0>b.h&&(b.h=0);0>b.w&&(b.w=0);C("#"+n+"-"+a,d).css({left:b.x,top:b.y,width:b.w,height:b.h})}B.each(q,function(b){C("#"+n+"-"+b.name,d).css({left:a.w*b.xMul+a.x,top:a.h*b.yMul+a.y})});c("top",{x:b.x,y:b.y,w:b.w,h:a.y-b.y});c("right",{x:a.x+a.w,y:a.y,w:b.w-a.x-a.w+b.x,h:a.h});c("bottom",{x:b.x,y:a.y+a.h,w:b.w,h:b.h-a.y-a.h+b.y});c("left",{x:b.x,y:a.y,w:a.x-b.x,h:a.h});c("move",a)}function g(b){f(a=b)}function k(a){var b;g((b=c,{x:a.x+b.x,y:a.y+b.y,w:a.w,h:a.h}))}var l,q,p,r,n="mce-crid-"+ib++;return q=
[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],r=["top","right","bottom","left"],C('<div id="'+
n+'" class="mce-croprect-container" role="grid" aria-dropeffect="execute">').appendTo(d),B.each(r,function(a){C("#"+n,d).append('<div id="'+n+"-"+a+'"class="mce-croprect-block" style="display: none" data-mce-bogus="all">')}),B.each(q,function(a){C("#"+n,d).append('<div id="'+n+"-"+a.name+'" class="mce-croprect-handle mce-croprect-handle-'+a.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+a.label+'" aria-grabbed="false">')}),p=B.map(q,function(b){var c;
return new (ka.get("DragHelper"))(n,{document:d.ownerDocument,handle:n+"-"+b.name,start:function(){c=a},drag:function(a){h(b,c,a.deltaX,a.deltaY)}})}),f(a),C(d).on("focusin focusout",function(a){C(a.target).attr("aria-grabbed","focus"===a.type)}),C(d).on("keydown",function(b){function c(a,b,c,f,m){a.stopPropagation();a.preventDefault();h(d,c,f,m)}var d;switch(B.each(q,function(a){if(b.target.id===n+"-"+a.name)return d=a,!1}),b.keyCode){case ha.LEFT:c(b,0,a,-10,0);break;case ha.RIGHT:c(b,0,a,10,0);
break;case ha.UP:c(b,0,a,0,-10);break;case ha.DOWN:c(b,0,a,0,10);break;case ha.ENTER:case ha.SPACEBAR:b.preventDefault(),m()}}),l=B.extend({toggleVisibility:function(a){var b;b=B.map(q,function(a){return"#"+n+"-"+a.name}).concat(B.map(r,function(a){return"#"+n+"-"+a})).join(",");a?C(b,d).show():C(b,d).hide()},setClampRect:function(b){c=b;f(a)},setRect:g,getInnerRect:function(){return{x:a.x-c.x,y:a.y-c.y,w:a.w,h:a.h}},setInnerRect:k,setViewPortRect:function(c){b=c;f(a)},destroy:function(){B.each(p,
function(a){a.destroy()});p=[]}},hb)}(a,c.state.get("viewRect"),c.state.get("viewRect"),c.getEl(),function(){c.fire("crop")});c.cropRect.on("updateRect",function(a){a=a.rect;var b=c.zoom();a={x:Math.round(a.x/b),y:Math.round(a.y/b),w:Math.round(a.w/b),h:Math.round(a.h/b)};c.state.set("rect",a)});c.on("remove",c.cropRect.destroy)}var c=this;c.state.on("change:cropEnabled",function(a){c.cropRect.toggleVisibility(a.value);c.repaintImage()});c.state.on("change:zoom",function(){c.repaintImage()});c.state.on("change:rect",
function(b){b=b.value;c.cropRect||a(b);c.cropRect.setRect(b)})}}))(a)}},jb={edit:function(a,b){return new D(function(c,d){return b.toBlob().then(function(b){$a(a,ea(b),c,d)})})}},ma={getImageSize:function(a){var b,c;return b=a.style.width,c=a.style.height,b||c?/^[0-9\.]+px$/.test(b)&&/^[0-9\.]+px$/.test(c)?{w:parseInt(b,10),h:parseInt(c,10)}:null:(b=a.width,c=a.height,b&&c?{w:parseInt(b,10),h:parseInt(c,10)}:null)},setImageSize:function(a,b){var c,d;b&&(c=a.style.width,d=a.style.height,(c||d)&&(a.style.width=
b.w+"px",a.style.height=b.h+"px",a.removeAttribute("data-mce-style")),c=a.width,d=a.height,(c||d)&&(a.setAttribute("width",b.w),a.setAttribute("height",b.h)))},getNaturalImageSize:function(a){return{w:a.naturalWidth,h:a.naturalHeight}}},Ma=(Array.prototype.indexOf,void 0,Array.prototype.push,Array.prototype.slice,function(a,b){for(var c=0,d=a.length;c<d;c++){var f=a[c];if(b(f,c,a))return oa.some(f)}return oa.none()}),na={traverse:function(a,b){var c;return c=b.reduce(function(a,b){return null!==a&&
void 0!==a?a[b]:void 0},a),null!==c&&void 0!==c?c:null},readBlob:function(a){return new D(function(b){var c=new g;c.onload=function(a){b(a.target.result)};c.readAsText(a)})},requestUrlAsBlob:function(a,b){return new D(function(c){var d;(d=new function(){return new (M.getOrDie("XMLHttpRequest"))}).onreadystatechange=function(){4===d.readyState&&c({status:d.status,blob:this.response})};d.open("GET",a,!0);B.each(b,function(a,b){d.setRequestHeader(b,a)});d.responseType="blob";d.send()})},parseJson:function(a){var b;
try{b=JSON.parse(a)}catch(c){}return b}},kb=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],lb=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],Na=function(a){return"ImageProxy HTTP error: "+Ma(kb,function(b){return a===b.code}).fold(J.constant("Unknown ImageProxy error"),
function(a){return a.message})},Oa=function(a){a=Na(a);return D.reject(a)},Pa=function(a){return Ma(lb,function(b){return b.type===a}).fold(J.constant("Unknown service error"),function(a){return a.message})},mb=function(a,b){return na.readBlob(b).then(function(a){var b,c;a=(b=na.parseJson(a),"ImageProxy Service error: "+((c=na.traverse(b,["error","type"]))?Pa(c):"Invalid JSON in service error message"));return D.reject(a)})},Qa={handleServiceErrorResponse:function(a,b){return 400===(c=a)||403===c||
500===c?mb(0,b):Oa(a);var c},handleHttpError:Oa,getHttpErrorMsg:Na,getServiceErrorMsg:Pa},nb=function(a,b){return na.requestUrlAsBlob((c=a,d=b,f=-1===c.indexOf("?")?"?":"&",/[?&]apiKey=/.test(c)||!d?c:c+f+"apiKey="+encodeURIComponent(d)),{"Content-Type":"application/json;charset=UTF-8","tiny-api-key":b}).then(function(a){return 200>a.status||300<=a.status?Qa.handleServiceErrorResponse(a.status,a.blob):D.resolve(a.blob)});var c,d,f},Ra=function(a,b){return b?nb(a,b):(c=a,na.requestUrlAsBlob(c,{}).then(function(a){return 200>
a.status||300<=a.status?Qa.handleHttpError(a.status):D.resolve(a.blob)}));var c},ob=0,Sa=function(a,b){b=b.src;return 0===b.indexOf("data:")||0===b.indexOf("blob:")||(new Aa(b)).host===a.documentBaseURI.host},Ta=function(a){var b,c,d,f;return(b=a.editorUpload.blobCache.getByUri(a.selection.getNode().src))?D.resolve(b.blob()):(c=a.selection.getNode(),-1!==B.inArray(a.settings.imagetools_cors_hosts,(new Aa(c.src)).host)?Ra(c.src,null):Sa(a,c)?N.imageToBlob(c):(f=a.getParam("imagetools_proxy"),f+=(-1===
f.indexOf("?")?"?":"&")+"url="+encodeURIComponent(c.src),d=a.settings.api_key||a.settings.imagetools_api_key,Ra(f,d)))},pb=function(a,b){var c=fb.setEditorTimeout(a,function(){a.editorUpload.uploadImagesAuto()},a.settings.images_upload_timeout||3E4);b.set(c)},Ua=function(a){clearTimeout(a.get())},Va=function(a,b,c,d,f){return b.toBlob().then(function(g){var h,m,k,l,n,p;return k=a.editorUpload.blobCache,h=(n=a.selection.getNode()).src,a.settings.images_reuse_filename&&((l=k.getByUri(h))?(h=l.uri(),
m=l.name()):m=(p=h.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?a.dom.encode(p[1]):null),l=k.create({id:"imagetools"+ob++,blob:g,base64:b.toBase64(),uri:h,name:m}),k.add(l),a.undoManager.transact(function(){a.$(n).on("load",function Ya(){a.$(n).off("load",Ya);a.nodeChanged();c?a.editorUpload.uploadImagesAuto():(Ua(d),pb(a,d))});f&&a.$(n).attr({width:f.w,height:f.h});a.$(n).attr({src:l.blobUri()}).removeAttr("data-mce-src")}),l})},Wa=function(a,b,c,d){return function(){return a._scanForImages().then(J.curry(Ta,
a)).then(aa.blobToImageResult).then(c).then(function(c){return Va(a,c,!1,b,d)},function(b){a.notificationManager.open({text:b,type:"error"})})}},O={rotate:function(a,b,c){return function(){var d=ma.getImageSize(a.selection.getNode());return Wa(a,b,function(a){return x.rotate(a,c)},d?{w:d.h,h:d.w}:null)()}},flip:function(a,b,c){return function(){return Wa(a,b,function(a){return x.flip(a,c)})()}},editImageDialog:function(a,b){return function(){var c=a.selection.getNode(),d=ma.getNaturalImageSize(c),
f=function(a){return new D(function(b){N.blobToImage(a).then(function(f){var g=ma.getNaturalImageSize(f);d.w===g.w&&d.h===g.h||ma.getImageSize(c)&&ma.setImageSize(c,g);ta.revokeObjectURL(f.src);b(a)})})};Ta(a).then(aa.blobToImageResult).then(J.curry(function(a,c){return jb.edit(a,c).then(f).then(aa.blobToImageResult).then(function(c){return Va(a,c,!0,b)},function(){})},a),function(b){a.notificationManager.open({text:b,type:"error"})})}},isEditableImage:function(a,b){return a.dom.is(b,"img:not([data-mce-object],[data-mce-placeholder])")&&
(Sa(a,b)||-1!==B.inArray(a.settings.imagetools_cors_hosts,(new Aa(b.src)).host)||a.settings.imagetools_proxy)},cancelTimedUpload:Ua},qb=function(a,b){B.each({mceImageRotateLeft:O.rotate(a,b,-90),mceImageRotateRight:O.rotate(a,b,90),mceImageFlipVertical:O.flip(a,b,"v"),mceImageFlipHorizontal:O.flip(a,b,"h"),mceEditImage:O.editImageDialog(a,b)},function(b,d){a.addCommand(d,b)})},rb=function(a,b,c){a.on("NodeChange",function(d){var f=c.get();f&&f.src!==d.element.src&&(O.cancelTimedUpload(b),a.editorUpload.uploadImagesAuto(),
c.set(null));O.isEditableImage(a,d.element)&&c.set(d.element)})};cb.add("imagetools",function(a){var b=ua(0),c=ua(null);qb(a,b);a.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"});a.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"});a.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"});a.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"});a.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"});
a.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"});a.addContextToolbar(J.curry(O.isEditableImage,a),a.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions"));rb(a,b,c)})}();
